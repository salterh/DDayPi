<!DOCTYPE html>
<html lang='en'>

<head>
    <meta charset='utf-8' />
    <script src='./lib/p5.min.js'></script>
    <script src='./lib/p5.sound.min.js'></script>
    <script src='./lib/p5.speech.js'></script>
</head>

<body>
    <script type='text/javascript'>

        let xhr = new XMLHttpRequest();
        

        function checkGPIO() {
            xhr.open("GET", "/startMic");
            xhr.send();
        }

        xhr.onload = () => {
            console.log(xhr.status, xhr.response);
            //setTimeout(checkGPIO, 100);
        }

        var intros = [],
            LBClues = [],
            MOClues = [],
            NCClues = [],
            UDClues = [],
            clues = [LBClues, NCClues, MOClues, UDClues],
            introSample,
            finalSample,
            wrongSample;


        var globalIndex = -2,
            speechCounter = 0,
            clueCounter = -1;

        var speech, check;

        var nextButton,
            prevButton,
            clueButton;

        var currentlyPlaying;

        function preload() {
            for (let i = 0; i < 4; i++) {
                intros[i] = loadSound('./Audio/intro' + i + '.wav');
            }
            for (let i = 0; i < 2; i++) {
                LBClues[i] = loadSound('./Audio/LBClue' + i + '.wav');
                NCClues[i] = loadSound('./Audio/NCClue' + i + '.wav');
            }
            MOClues[0] = loadSound('./Audio/MOClue0.wav');
            UDClues[0] = loadSound('./Audio/UDClue0.wav');

            introSample = loadSound('./Audio/mainIntro.wav');
            introSample.playMode('restart');

            finalSample = loadSound('./Audio/finalSample.wav');
            // wrongSample = loadSound('./Audio/wrongSample.wav');

        }

        function setup() {
            nextButton = createButton('NEXT');
            nextButton.mousePressed(playNext);
            prevButton = createButton('PREV');
            prevButton.mousePressed(playPrev);
            clueButton = createButton('CLUE');
            clueButton.mousePressed(clue);
            speech = new p5.SpeechRec();
            speech.onResult = speechFinished;
        }

        function draw() {

        }

        function playNext() {
            globalIndex++;
            clueCounter = -1;
            if (globalIndex > intros.length - 1)
                globalIndex = intros.length - 1;

            if (currentlyPlaying != undefined)
                currentlyPlaying.stop();

            if (globalIndex == -1) {
                introSample.play();
                currentlyPlaying = introSample;
            }
            else {
                intros[globalIndex].play();
                currentlyPlaying = intros[globalIndex];
            }
        }

        function playPrev() {
            globalIndex--;
            clueCounter = -1;
            if (globalIndex < -1)
                globalIndex = -1;

            if (currentlyPlaying != undefined)
                currentlyPlaying.stop();

            if (globalIndex == -1) {
                introSample.play();
                currentlyPlaying = introSample;
            }
            else {
                intros[globalIndex].play();
                currentlyPlaying = intros[globalIndex];
            }

        }

        function clue() {
            if (currentlyPlaying != undefined)
                currentlyPlaying.stop();
            speech.start();
            checkGPIO();
        }

        function speechFinished() {
            let data = speech.resultString.toUpperCase();
            if (data.includes('RING') && data.includes('ENGINE')) {
                // finalSample.play();
                console.log('Final Sample Playing');
            }
            else if (data.includes("HELP") || data.includes("HINT") || data.includes("CLUE")) {
                console.log("Giving a clue...");
                clueCounter++;
                if (clueCounter > clues[globalIndex].length - 1)
                    clueCounter = 0;
                clues[globalIndex][clueCounter].play();
                currentlyPlaying = clues[globalIndex][clueCounter];
            }
            else {
                // wrongSample.play();
                console.log('Sorry I don\'t understand...');
            }
        }
    </script>
</body>

</html>